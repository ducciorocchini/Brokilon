# creare un buffer intorno ad un punto: quanta superficie di terreno è disponinile?

#set working directory
setwd("~/dati/DATA-CLCRASTER")

#librerie utilizzate
library(raster)
library(rgdal)
library(rasterVis)


# caricare dati

clc <- raster("U2018_CLC2018_V2020_20u1.tif.ovr")

#informazioni
clc

plot(clc)
 
 # Europa: facciamo uno zoom sull'Italia
 extension <- c(14800,21500,500,10000)
 zoom(clc, ext=extension) #solo per controllare
 
clcItaly <- crop(clc, extension)
clcItaly
plot(clcItaly)
 

# è un fattore?
is.factor(clcItaly)
# trasformare in fattore 


factclcItaly <- as.factor(clcItaly) #convert to factor
levels(clcItaly) #NULL
levels(factclcItaly)



#45 livelli
#ID 
land_cover <- levels(factclcItaly)

#rinominare le ID
land_cover[,"landcover"] <- c ( “Continuous urban fabric”, “Discontinuous urban fabric”, “Industrial or commercial units”, “Road and rail networks and associated land”, “Port areas”, “Airports”, “Mineral extraction sites”, “Dump sites”, “Construction sites”, “Green urban areas”, “Sport and leisure facilities”, “Non-irrigated arable land”, “Permanently irrigated land”, “Rice fields”, “Vineyards”, “Fruit trees and berry plantations”, “Olive groves”, “Pastures”,  “Annual crops associated with permanent crops”, “Complex cultivation patterns”, “Land principally occupied by agriculture with significant areas of natural vegetation”, “Agro-forestry areas”, “Broad-leaved forest”, “Coniferous forest”, “Mixed forest”, “Natural grasslands”, “Moors and heathland”, “Sclerophyllous vegetation”, “Transitional woodland-shrub”,  “Beaches dunes sands”, “Bare rocks”, “Sparsely vegetated areas”, “Burnt areas”, “Glaciers and perpetual snow”, “Inland marshes”, “Peat bogs”, “Salt marshes”, “Salines”, “Intertidal flats”, “Water courses”, “Water bodies”, “Coastal lagoons”, “Estuaries”, “Sea and ocean”, “NODATA”)




#buffer 
## buffer: 250m, 500m, 1000, 1km, 2km, 2,5 km.  land_cover <- levels(factItaly)

buf250m <- 250
buffer.250m <- buffer(clcItaly, width=buf250m)

buf500m <- 500
buffer.500m <- buffer(clcItaly, width=buf500m)

buf1000m <- 1000
buffer.1000 <- buffer(clcItaly, width=buf1000)


buf2000 <- 2000
buffer.2000 <- buffer(clcItaly, width=buf2000)

buf2500 <- 2500
buffer.2500 <- buffer(clcItaly, width=buf2500)



The raster package has a useful function for viewing portions of raster layers.
Here we use the zoom function to zoom into the buffer we just created.
#zoom into area for viewing
> zoom(nlcd,buffer.site1.5km)
> plot(buffer.site1.5km, border="red", lwd = 5, add=T)
> plot(buffer.site1.1km, border="red", lwd = 3, add=T)
> points(sites[1,], pch=19, cex=2, add=T)

plot(buffer.2000, border="red", lwd=5, add=T)

How can we extract appropriate information at different scales? Let us focus on
this first site. Once we can capture the information we need for one point, we then
repeat for all sites. There are several ways to accomplish this task. The simplest way
is to take the buffered layer we just created and use the crop and mask functions:
> buffer.forest1.1km <- crop(forest, buffer.site1.1km)
> buffer.forest1.1km <- mask(forest, buffer.site1.1km)

#area of each cell, in ha
> grainarea <- res(forest)[[1]]^2/10000
#area of 1km buffer
> bufferarea <- (3.14159*buf1km^2)/10000
#calculation of forest cover and % cover
> forestcover1km <- cellStats(buffer.forest1.1km, 'sum') *
grainarea
> percentforest1km <- forestcover1km / bufferarea * 100




#crop and mask functions
## mask: create a new raster: requires x-y locations of point 
#cellsStats function (raster packages) --> sum the amount of forest cover
#rasterize : convert buffer into a raster layer : computationally quicker 

#spatialEco : calculate landascape metric surrounding points 
